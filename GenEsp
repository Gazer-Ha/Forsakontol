local cref = cloneref or function(ref) return ref end
local ts = cref(game:GetService("TweenService"))
local ws = cref(workspace)

local gens, hl = {}, {}

local function getColors(p)
    local progress = math.clamp(p / 100, 0, 1)
    
    -- Color transition logic:
    local fillColor
    if progress < 1 then
        fillColor = Color3.new(1, progress, 0) -- Red (1,0,0) to Yellow (1,1,0)
    else
        fillColor = Color3.new(0, 1, 0) -- Green (0,1,0) at 100%
    end
    
    local outlineColor = fillColor:Lerp(Color3.new(0, 0, 0), 0.3) -- Slightly darker outline

    return fillColor, outlineColor
end

local function updateHL(gen)
    local prog, h = gen:FindFirstChild("Progress"), hl[gen]
    if prog and h then
        local f, o = getColors(prog.Value)
        local speed = 0.1
        
        local tf = ts:Create(h, TweenInfo.new(speed, Enum.EasingStyle.Linear), {FillColor = f})
        local to = ts:Create(h, TweenInfo.new(speed, Enum.EasingStyle.Linear), {OutlineColor = o})
        tf:Play()
        to:Play()
        
        tf.Completed:Connect(function()
            tf:Destroy()
            to:Destroy()
        end)
    end
end

local function addGen(obj)
    if obj:IsA("Model") and obj.Name == "Generator" and not gens[obj] then
        gens[obj] = true
        local h = Instance.new("Highlight", obj)
        h.Adornee, hl[obj] = obj, h
        local f, o = getColors(1)
        h.FillColor, h.OutlineColor = f, o
        local prog = obj:FindFirstChild("Progress")
        if prog and prog:IsA("NumberValue") then
            prog.Changed:Connect(function() updateHL(obj) end)
            updateHL(obj)
        end
    end
end

local function removeGen(obj)
    if gens[obj] then
        gens[obj], hl[obj] = nil, nil
        if hl[obj] then hl[obj]:Destroy() end
    end
end

local function scanGens()
    local m = ws:FindFirstChild("Map")
    local gm = m and m:FindFirstChild("Ingame") and m.Ingame:FindFirstChild("Map")
    if gm then
        gens, hl = {}, {}
        for _, obj in ipairs(gm:GetChildren()) do
            task.wait(0.5)
            addGen(obj)
        end
        gm.ChildAdded:Connect(addGen)
        gm.ChildRemoved:Connect(removeGen)
    end
end

task.spawn(function()
    while true do
        scanGens()
        task.wait(10)
    end
end)
